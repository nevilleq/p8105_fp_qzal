---
title: "Lyuou"
author: "Lyuou Zhang"
date: "11/19/2018"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(plotly)
library(rgdal)
library(plotly)
library(maps)


library(devtools)

library(leaflet)

```


```{r include = FALSE}
# data import
dog_bite <- read_csv('./data/dog_bite.csv', skip = 2)

dog_license <- read_csv('./data/cleaned_license_data.csv')
  
  
```

### ggplot

```{r}
dog_bite %>% 
  ggplot(aes(x = gender, fill = spay_neuter)) + geom_bar() +
  labs(
    title = 'Number of dogs spayed/neutered by gender',
    x = 'Gender',
    y = 'Count'
  ) +
  scale_x_discrete(
    labels = c('Female', 'Male', 'Unidentified')
  )

```

### or plotly?

```{r}
dog_bite %>% 
  group_by(gender, spay_neuter) %>% 
  summarize(n = n()) %>% 
  mutate(text_label = str_c('Gender: ', gender, '\nnumber: ', n)) %>% 
  plot_ly(x = ~gender, y = ~n, color = ~spay_neuter, type = 'bar', text = ~text_label) %>% 
  layout(
     xaxis = list(text = c('Female', 'Male', 'Unidentified')),
     yaxis = list(title = "count"), barmode = "stack")


```

* We found that there are more Male and Unidentified dogs than female.  
* Among Male and Female dogs, the number of dogs that were spayed/neutered or unneutered are similar.  
* Among dogs whose gender are unidentified, most dogs were not spayed/neutered.

# Copied from Q_work
# Imputing Zip Codes
```{r message = FALSE}
nyc.official.zip <- read_csv("./data/Demographic_Statistics_By_Zip_Code.csv") %>%
  janitor::clean_names() %>% 
  rename(official_zip = jurisdiction_name) %>%
  select(official_zip)


official.zip <- paste0(nyc.official.zip$official_zip, collapse = "|")
  
#https://data.cityofnewyork.us/City-Government/Demographic-Statistics-By-Zip-Code/kku6-nxdu
```

```{r warning = FALSE, message = FALSE}
dog.bite.df <- read_csv("./data/DOHMH_Dog_Bite_Data.csv") %>%
  janitor::clean_names() %>%
  mutate(
    zip_code = zip_code %>% 
               ifelse(str_length(.) != 5, NA, .) %>% 
               str_replace(., "O", "0") %>% 
               ifelse(str_detect(., "^[02-9]"), NA, .),
    zip_match = str_detect(zip_code, official.zip),
    zip_code  = ifelse(zip_match == FALSE, NA, zip_code)
  ) %>%
  left_join(.,
            na.omit(.) %>% 
            left_join(., count(., borough), by = "borough") %>% 
            group_by(borough, zip_code) %>%
            summarize(proportion = n()/unique(n)) %>% 
            rename(zip_list = zip_code) %>%
            nest(zip_list, proportion) %>% rename(zip_nest = data))

#Missing Zips
dog.bite.df %>% summarize(missing_zip = sum(is.na(zip_code))/n())

#Missing Zips by borough
dog.bite.df %>% group_by(borough) %>% summarize(missing_zip = sum(is.na(zip_code))/n())

#Set Seed
set.seed(4)

#Imputing Zip Code
dog.bite.df <- dog.bite.df %>%
  mutate(
    zip_sample = map_chr(.x = zip_nest, ~sample(.x$zip_list, 1, prob = .x$proportion)),
    zip_code_imputed = zip_code %>% ifelse(is.na(.), zip_sample, .)
  ) %>% select(-c(zip_nest, zip_sample))

#View Data
dog.bite.df %>% select(borough, zip_code, zip_code_imputed)

#Num Distinct Zips
dog.bite.df %>% distinct(., zip_code_imputed) %>% nrow()
```

# Number of dog bites by zip code tabulation areas?


```{r}
# count the number of dog bite incidence by zip code

bite_count <- dog.bite.df %>% 
  group_by(zip_code_imputed) %>% 
  summarize(n_bite = n())


```

## Import spatial data/map

```{r}
# zip code tabulation area
# https://data.cityofnewyork.us/Business/Zip-Code-Boundaries/i8iw-xf4u/data
# import the shape file
# https://plotly-book.cpsievert.me/maps.html

zip_map <- readOGR(dsn = './data/ZIP_CODE_040114/ZIP_CODE_040114.shp', encoding = "UTF-8")

zip_map@data <- left_join(zip_map@data, bite_count, by = c('ZIPCODE' = 'zip_code_imputed'))


```

Interactive choropleth map by leaflet

```{r}

# CRS setting
zip_map_crs <- spTransform(zip_map, CRS("+init=epsg:4326"))

# export the json file
writeOGR(zip_map_crs, './data/zip_map_geojson', layer = 'zip_map', driver = 'GeoJSON')


# Layout 
# format of the label that pops up for each polygon
label_popup <- paste0(
  "<strong>Zip code: </strong>",
  zip_map$ZIPCODE,
  "<br><strong>Number of dog bites: </strong>",
  zip_map$n_bite
)

cuts <- round(quantile(zip_map$n_bite, probs = seq(0, 1, 0.25), na.rm = TRUE), 0)
cuts[1] <- 2

sty <- styleGrad(prop = "count",
 breaks = cuts, # from the "cuts" creation, above
 right = FALSE,
 style.par = "col",
 style.val = rev(heat.colors(4)),
 leg = "dog bites", lwd = 1)

# legend setting
pal <- colorBin(palette = "BuPu", domain = zip_map$n_bite, bins = 5)

# choropleth map
leaflet::leaflet(data = zip_map_crs) %>% 
  addProviderTiles('CartoDB.Positron') %>% 
  addPolygons(fillColor = ~pal(n_bite),
              fillOpacity = 0.7,
              color = "#BDBDC3",
              weight = 1,
              popup = label_popup) %>% 
  addLegend('bottomleft',
            pal = pal,
            values = ~n_bite,
            title = 'n_bite',
            opacity = 1)



```







